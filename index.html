<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <!-- 1. CSP 必須最先定義（安全開發守則【CORS 嚴格設定】） -->
  <meta http-equiv="Content-Security-Policy" 
        content="default-src 'self'; 
                 script-src 'self' 'nonce-TRAILSYNC_SECURE' https://unpkg.com;
                 style-src 'self' 'nonce-TRAILSYNC_SECURE' https://unpkg.com;
                 img-src 'self' https://tile.openstreetmap.org;
                 connect-src 'self';
                 sandbox allow-scripts allow-same-origin;">
  
  <title>TrailSync - 越野跑智能訓練分析平台</title>
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
  <!-- 2. DOM 元素必須存在 -->
  <header>...</header>
  <main>
    <div id="module-container"></div>
  </main>
  <footer>...</footer>

  <!-- 3. 第三方庫帶 SRI（安全開發守則【使用 SRI】） -->
  <script src="assets/libs/chart.min.js" 
          integrity="sha384-..." 
          crossorigin="anonymous" 
          nonce="TRAILSYNC_SECURE"></script>
  <script src="assets/libs/leaflet.js" 
          integrity="sha384-..." 
          crossorigin="anonymous" 
          nonce="TRAILSYNC_SECURE"></script>

  <!-- 4. 安全核心模組（SDL 流程優先載入） -->
  <script type="module" nonce="TRAILSYNC_SECURE">
    // 安全開發守則強制：【在任何業務邏輯前初始化安全系統】
    import { SecurityCore } from './assets/js/core/security.js';
    window.security = new SecurityCore();
    
    // 安全開發守則強制：【阻斷未通過安全檢查的瀏覽器】
    if (!window.security.isBrowserSecure()) {
      document.body.innerHTML = `
        <div class="security-block">
          <h2>⚠️ 安全阻斷</h2>
          <p>您的瀏覽器不支援 Web Crypto API，無法安全存儲訓練數據</p>
          <p>請升級至 Chrome 110+ / Firefox 115+ / Safari 16.4+</p>
        </div>
      `;
      throw new Error('UNSUPPORTED_BROWSER');
    }
    
    // 安全開發守則強制：【模塊載入器（安全沙箱化）】
    import { ModuleLoader } from './assets/js/core/sandbox.js';
    const loader = new ModuleLoader({
      container: '#module-container',
      modules: {
        calculator: 'modules/core-calculator.html',
        planner: 'modules/interval-planner.html',
        converter: 'modules/treadmill-converter.html',
        assessor: 'modules/race-assessor.html',
        dashboard: 'modules/athlete-dashboard.html',
        analytics: 'modules/analytics-lab.html'
      }
    });
    
    // 預載入安全模塊（符合 SDL 威脅建模）
    await loader.preloadAll();
    
    // 路由安全控制
    document.querySelectorAll('nav a').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const module = link.href.split('#')[1];
        loader.loadModule(module).catch(err => {
          window.security.logSecurityEvent('MODULE_LOAD_FAILED', { 
            module, 
            error: err.message 
          });
          alert('模塊載入失敗！已記錄安全事件');
        });
      });
    });
    
    // 預設載入核心計算器
    loader.loadModule('calculator');
  </script>
</body>
</html>

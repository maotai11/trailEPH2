<section id="race-assessor" class="module">
  <h2>完賽風險評估</h2>
  
  <div class="input-section">
    <h3>目標賽事參數</h3>
    <form id="raceForm">
      <div class="form-group">
        <label>賽事距離 (km): 
          <input type="number" id="raceDistance" min="5" step="0.1" required>
        </label>
      </div>
      <div class="form-group">
        <label>總爬升 (m): 
          <input type="number" id="raceElevation" min="0" step="1" required>
        </label>
      </div>
      <div class="form-group">
        <label>關門時間: 
          <input type="text" id="raceDuration" placeholder="12:00:00" pattern="\d{1,2}:\d{2}:\d{2}" required>
        </label>
      </div>
      <button type="submit">評估風險</button>
    </form>
  </div>
  
  <div class="result-section" id="riskResult" hidden>
    <h3>風險評估結果</h3>
    <div class="risk-level" id="riskLevel">待評估</div>
    
    <div class="risk-details">
      <h4>主要風險來源</h4>
      <ul id="riskSources"></ul>
      
      <h4>預估完賽時間</h4>
      <div id="estimatedTime">計算中...</div>
    </div>
    
    <div class="ai-suggestions" id="aiSuggestions">
      <h4>AI 教練建議</h4>
      <div id="suggestionsContent"></div>
      <button id="regenerateSuggestions">重新生成建議</button>
    </div>
  </div>
</section>

<script nonce="TRAILSYNC_SECURE">
document.addEventListener('DOMContentLoaded', () => {
  // 安全開發守則強制：【預設不信任使用者輸入】
  document.getElementById('raceForm').addEventListener('submit', handleRiskAssessment);
  document.getElementById('regenerateSuggestions').addEventListener('click', generateAiSuggestions);
  
  // 檢查是否有歷史數據
  checkHistoricalData();
});

/**
 * 檢查歷史數據可用性
 */
async function checkHistoricalData() {
  try {
    const activities = await window.secureStorage.getItem('activities') || [];
    if (activities.length === 0) {
      const statusEl = document.querySelector('.input-section');
      window.security.renderSafeContent(
        statusEl, 
        statusEl.innerHTML + 
        '<div class="warning">⚠️ 需要至少 3 次歷史活動數據才能進行風險評估</div>'
      );
    }
  } catch (e) {
    window.security.logSecurityEvent('HISTORICAL_DATA_CHECK_FAILED', { error: e.message });
  }
}

/**
 * 安全處理風險評估
 */
async function handleRiskAssessment(e) {
  e.preventDefault();
  
  // 安全開發守則強制：【防止注入攻擊】
  const safeInputs = {
    distance: parseFloat(document.getElementById('raceDistance').value),
    elevation: parseFloat(document.getElementById('raceElevation').value),
    duration: document.getElementById('raceDuration').value
  };
  
  // 安全驗證輸入
  if (!validateRaceInputs(safeInputs)) {
    window.security.renderSafeContent(
      document.getElementById('riskResult'), 
      '<div class="error">請輸入有效的賽事參數！</div>'
    );
    return;
  }
  
  try {
    // 安全獲取歷史數據
    const activities = await window.secureStorage.getItem('activities') || [];
    if (activities.length < 3) {
      throw new Error('INSUFFICIENT_DATA');
    }
    
    // 安全計算風險
    const riskResult = calculateRisk(safeInputs, activities);
    
    // 安全顯示結果
    displayRiskResult(riskResult);
    
    // 安全生成 AI 建議
    generateAiSuggestions();
    
    // 安全日誌
    window.security.logSecurityEvent('RISK_ASSESSMENT_COMPLETED', { 
      raceDistance: safeInputs.distance,
      riskLevel: riskResult.level 
    });
  } catch (e) {
    window.security.logSecurityEvent('RISK_CALCULATION_ERROR', { error: e.message });
    
    let errorMsg = '風險評估失敗';
    if (e.message === 'INSUFFICIENT_DATA') {
      errorMsg = '需要至少 3 次歷史活動數據';
    }
    
    window.security.renderSafeContent(
      document.getElementById('riskResult'), 
      `<div class="error">${window.security.sanitizeInput(errorMsg)}</div>`
    );
  }
}

/**
 * 安全驗證賽事輸入
 */
function validateRaceInputs(inputs) {
  // 安全開發守則強制：【預設不信任使用者輸入】
  if (isNaN(inputs.distance) || inputs.distance < 5) return false;
  if (isNaN(inputs.elevation) || inputs.elevation < 0) return false;
  
  // 驗證時間格式
  const timePattern = /^\d{1,2}:\d{2}:\d{2}$/;
  if (!timePattern.test(inputs.duration)) return false;
  
  return true;
}

/**
 * 安全計算風險
 */
function calculateRisk(race, activities) {
  // 解析關門時間
  const [hours, minutes, seconds] = race.duration.split(':').map(Number);
  const cutoffHours = hours + minutes/60 + seconds/3600;
  
  // 計算賽事 EP
  const raceEp = race.distance + race.elevation / 100;
  const raceEph = raceEp / cutoffHours;
  
  // 分析歷史數據
  const longestRun = activities.reduce((max, act) => 
    parseFloat(act.distance) > parseFloat(max.distance) ? act : max, 
    activities[0]
  );
  
  const longestElevation = activities.reduce((max, act) => 
    parseFloat(act.elevation) > parseFloat(max.elevation) ? act : max, 
    activities[0]
  );
  
  // 計算缺口百分比
  const distanceGap = (race.distance - longestRun.distance) / race.distance;
  const elevationGap = (race.elevation - longestElevation.elevation) / race.elevation;
  
  // 時間膨脹係數（安全邊界檢查）
  let timeFactor = 1.0;
  if (distanceGap > 0.5) timeFactor *= 1.35;
  if (elevationGap > 0.4) timeFactor *= 1.28;
  
  // 預估完賽時間
  const estimatedHours = cutoffHours * timeFactor;
  const estimatedTime = formatDuration(estimatedHours);
  
  // 計算風險等級
  let level = 'low';
  let sources = [];
  
  if (distanceGap > 0.4) {
    sources.push(`您的最長距離 (${longestRun.distance}km) 僅為賽事的 ${((1-distanceGap)*100).toFixed(0)}%`);
    level = 'high';
  }
  
  if (elevationGap > 0.3) {
    sources.push(`您的最大爬升 (${longestElevation.elevation}m) 僅為賽事的 ${((1-elevationGap)*100).toFixed(0)}%`);
    level = level === 'low' ? 'medium' : 'high';
  }
  
  if (sources.length === 0) {
    sources.push('您的歷史數據顯示準備充分');
  }
  
  return {
    level,
    sources,
    estimatedTime,
    raceEp,
    raceEph,
    distanceGap,
    elevationGap
  };
}

/**
 * 安全顯示風險結果
 */
function displayRiskResult(result) {
  const resultEl = document.getElementById('riskResult');
  resultEl.hidden = false;
  
  // 安全設置風險等級（防範 DOM XSS）
  const levelEl = document.getElementById('riskLevel');
  levelEl.textContent = 
    result.level === 'high' ? '高風險' : 
    result.level === 'medium' ? '中風險' : '低風險';
  levelEl.className = `risk-level ${result.level}`;
  
  // 安全顯示風險來源
  const sourcesEl = document.getElementById('riskSources');
  sourcesEl.innerHTML = '';
  result.sources.forEach(source => {
    const li = document.createElement('li');
    // 安全開發守則強制：【防止 XSS】
    li.textContent = window.security.sanitizeInput(source);
    sourcesEl.appendChild(li);
  });
  
  // 安全顯示預估時間
  document.getElementById('estimatedTime').textContent = result.estimatedTime;
}

/**
 * 安全生成 AI 建議
 */
function generateAiSuggestions() {
  try {
    // 安全獲取當前風險評估
    const raceDistance = document.getElementById('raceDistance').value;
    const riskLevelEl = document.getElementById('riskLevel');
    
    if (!raceDistance || riskLevelEl.textContent === '待評估') {
      return;
    }
    
    // 安全開發守則強制：【防禦指令注入】
    const safeRaceDistance = window.security.sanitizeInput(raceDistance);
    
    // 模擬 AI 建議（實際應調用安全沙箱）
    const suggestions = [];
    const riskLevel = document.querySelector('.risk-level').className.split(' ')[1];
    
    if (riskLevel === 'high') {
      if (document.getElementById('riskSources').innerText.includes('距離')) {
        suggestions.push('✅ 長距離訓練：每週增加 10% 距離，目標達到賽事距離的 70%');
      }
      if (document.getElementById('riskSources').innerText.includes('爬升')) {
        suggestions.push('✅ 爬坡訓練：尋找 500m+ 連續爬升路段，每週 2 次');
      }
    } else if (riskLevel === 'medium') {
      suggestions.push('✅ 維持當前訓練量，專注技術路段效率');
      suggestions.push('✅ 每週 1 次模擬賽事強度的訓練');
    } else {
      suggestions.push('✅ 您已準備充分！建議維持訓練節奏');
      suggestions.push('✅ 關注賽前兩週的營養與睡眠');
    }
    
    // 安全顯示建議
    const suggestionsEl = document.getElementById('suggestionsContent');
    suggestionsEl.innerHTML = '<p>AI 生成建議，請根據自身感受調整：</p><ul>';
    
    suggestions.forEach(suggestion => {
      const li = document.createElement('li');
      // 安全開發守則強制：【防止 XSS】
      li.innerHTML = window.security.sanitizeInput(suggestion);
      suggestionsEl.querySelector('ul').appendChild(li);
    });
    
    suggestionsEl.innerHTML += '</ul>';
  } catch (e) {
    window.security.logSecurityEvent('AI_SUGGESTION_FAILED', { error: e.message });
    document.getElementById('suggestionsContent').innerHTML = 
      '<div class="error">建議生成失敗，請重試</div>';
  }
}
</script>